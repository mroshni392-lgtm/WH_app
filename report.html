<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports ‚Äì Waste Heat Map</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg:#0f1724; --card:#111b2e; --accent:linear-gradient(90deg,#7dd3fc,#60a5fa); --muted:#9aa4b2;
}
body.light { --bg:#f2f4f8; --card:#ffffff; --accent:linear-gradient(90deg,#2563eb,#60a5fa); --muted:#4b5563; color:#111827; }
body.ocean { --bg:#031f3b; --card:#0a2e52; --accent:linear-gradient(90deg,#38bdf8,#0ea5e9); --muted:#a3c8e2; }
body { background: var(--bg); color: #e6eef6; font-family: "Inter", sans-serif; margin: 0; padding: 20px; display:flex; flex-direction:column; align-items:center;}
nav { background: var(--card); padding: 14px; border-radius: 14px; width: 90%; text-align:center; margin-bottom:30px;}
nav a { color: #7dd3fc; margin:0 20px; text-decoration:none; font-weight:600;}
nav a:hover { color:#fff; text-shadow:0 0 8px #60a5fa; }
.card { background: var(--card); border-radius:16px; padding:24px; width:90%; max-width:800px; margin-bottom:25px; box-shadow:0 4px 20px rgba(0,0,0,0.5); transition:background 0.5s ease; }
h2 { color:#7dd3fc; text-align:center; margin-bottom:15px; }
canvas { margin-top:15px; border-radius:12px; background: var(--card);}
button { margin-top:15px; padding:10px 18px; border:none; border-radius:10px; background: var(--accent); color:#04263b; font-weight:600; cursor:pointer;}
#reportsList { margin-top:20px; color: var(--muted); }
.report-entry { margin-bottom:15px; padding:12px; border-radius:8px; background: rgba(255,255,255,0.05); }
.report-entry p { margin:4px 0; }
.delete-btn { background:#ef4444; color:#fff; padding:6px 12px; font-size:13px; margin-top:5px; border-radius:6px; cursor:pointer;}
.delete-btn:hover { background:#dc2626;}
.download-btn { background:#10b981; color:#fff; padding:6px 12px; font-size:13px; margin-top:5px; border-radius:6px; cursor:pointer;}
.download-btn:hover { background:#059669;}
</style>
</head>
<body>

<nav>
  <a href="heatmap.html">üè† Dashboard</a>
  <a href="report.html">üìä Report</a>
  <a href="settings.html">‚öôÔ∏è Settings</a>
  <a href="index.html" style="color:#f87171;">üö™ Logout</a>
</nav>

<div class="card">
  <h2>Project Reports</h2>
  <div id="reportsList"></div>
  <canvas id="reportChart"></canvas>
  <button onclick="downloadPDF()">‚¨áÔ∏è Download Overall Report</button>
</div>

<script>
(function applyTheme(){
  const theme = localStorage.getItem("theme");
  if(theme==="Light Mode") document.body.classList.add("light");
  else if(theme==="Ocean Blue") document.body.classList.add("ocean");
})();

let projects = JSON.parse(localStorage.getItem("projects")) || [];
const username = localStorage.getItem("username") || "Guest";
const email = localStorage.getItem("email") || "Not set";

const reportsList = document.getElementById("reportsList");

function displayReports(){
  reportsList.innerHTML="";
  projects.forEach((r, idx)=>{
    const div = document.createElement("div");
    div.classList.add("report-entry");
    div.innerHTML=`
      <strong>Report ${idx+1} - ${r.timestamp}</strong>
      <p><strong>Project Details:</strong> ${r.details || 'Not provided'}</p>
      <p><strong>Productivity Insights:</strong> ${r.productivity}</p>
      <p><strong>Waste Identification:</strong> ${r.waste}</p>
      <p><strong>Improvement Remedies:</strong> ${r.remedies}</p>
      <button class="delete-btn" onclick="deleteReport(${idx})">Delete</button>
      <button class="download-btn" onclick="downloadSingleReport(${idx})">‚¨áÔ∏è Download This</button>
    `;
    reportsList.appendChild(div);
  });
}

function deleteReport(idx){
  if(confirm("Are you sure you want to delete this report?")){
    projects.splice(idx,1);
    localStorage.setItem("projects", JSON.stringify(projects));
    displayReports();
    updateChart();
  }
}

displayReports();

// Aggregate chart
function updateChart(){
  let totalProd=0,totalNeutral=0,totalWaste=0;
  if(projects.length>0){
    totalProd = projects.reduce((sum,r)=>sum+(r.chartData?.productive||0),0)/projects.length;
    totalNeutral = projects.reduce((sum,r)=>sum+(r.chartData?.neutral||0),0)/projects.length;
    totalWaste = projects.reduce((sum,r)=>sum+(r.chartData?.waste||0),0)/projects.length;
  }
  if(window.reportChart) window.reportChart.destroy();
  const ctx=document.getElementById('reportChart').getContext('2d');
  window.reportChart=new Chart(ctx,{
    type:'doughnut',
    data:{labels:['Productive','Neutral','Waste'],datasets:[{data:[totalProd,totalNeutral,totalWaste],backgroundColor:['#16a34a','#facc15','#ef4444']}]},
    options:{plugins:{legend:{labels:{color:'var(--muted)'}}}}
  });
}

updateChart();

// Download Overall Report
async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text("Your Project Report",105,15,null,null,"center");

  doc.setFontSize(12);
  doc.text(`Name: ${username}`,15,25);
  doc.text(`Email: ${email}`,15,32);

  let y = 42;
  projects.forEach((r,idx)=>{
    doc.setFontSize(12);
    doc.text(`Report ${idx+1} - ${r.timestamp}`,15,y); y+=6;
    
    let projectLines = doc.splitTextToSize(r.details || 'Not provided', 180);
    doc.text(projectLines, 15, y); y += projectLines.length * 5;

    let prodLines = doc.splitTextToSize("Productivity Insights: "+r.productivity, 180);
    doc.text(prodLines, 15, y); y += prodLines.length * 5;

    let wasteLines = doc.splitTextToSize("Waste Identification: "+r.waste, 180);
    doc.text(wasteLines, 15, y); y += wasteLines.length * 5;

    let remedyLines = doc.splitTextToSize("Improvement Remedies: "+r.remedies, 180);
    doc.text(remedyLines, 15, y); y += remedyLines.length * 7;

    y += 5;
  });

  doc.setFontSize(10);
  doc.text("Handled by Waste HeatMap Teams",105,y,null,null,"center");

  await doc.save("project_report.pdf");
}

// Download single report
async function downloadSingleReport(idx){
  const { jsPDF } = window.jspdf;
  const r = projects[idx];
  if(!r) return;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text(`Project Report ${idx+1}`,105,15,null,null,"center");

  doc.setFontSize(12);
  doc.text(`Name: ${username}`,15,25);
  doc.text(`Email: ${email}`,15,32);

  let y = 42;
  doc.setFontSize(12);
  doc.text(`Report ${idx+1} - ${r.timestamp}`,15,y); y+=6;

  let projectLines = doc.splitTextToSize(r.details || 'Not provided', 180);
  doc.text(projectLines, 15, y); y += projectLines.length * 5;

  let prodLines = doc.splitTextToSize("Productivity Insights: "+r.productivity, 180);
  doc.text(prodLines, 15, y); y += prodLines.length * 5;

  let wasteLines = doc.splitTextToSize("Waste Identification: "+r.waste, 180);
  doc.text(wasteLines, 15, y); y += wasteLines.length * 5;

  let remedyLines = doc.splitTextToSize("Improvement Remedies: "+r.remedies, 180);
  doc.text(remedyLines, 15, y); y += remedyLines.length * 7;

  y += 5;
  doc.setFontSize(10);
  doc.text("Handled by Waste HeatMap Teams",105,y,null,null,"center");

  await doc.save(`project_report_${idx+1}.pdf`);
}
</script>
</body>
</html>
